# OCR ä¼˜åŒ–å‡çº§å®Œæˆ - PP-OCRv4 Server + é¢„å¤„ç†ç­–ç•¥

## ğŸ‰ å‡çº§æ¦‚è¿°

åŸºäºä½ çš„å»ºè®®ï¼Œå·²å®Œæˆä»¥ä¸‹æ ¸å¿ƒä¼˜åŒ–ï¼š

### â‘  æ¨¡å‹æœ¬ä½“å‡çº§
```python
# æ—§é…ç½® (mobile)
det_model="mobile"  # è½»é‡ä½†æ•ˆæœä¸€èˆ¬
rec_model="mobile"

# æ–°é…ç½® (server) âœ…
det_model="server"  # ç²¾åº¦æ›´é«˜ï¼Œé€‚åˆå¤æ‚èƒŒæ™¯
rec_model="server"
```

**æ”¹è¿›è¯´æ˜**:
- **PP-OCRv4 server** æ¨¡å‹å¤§å°å¢åŠ ï¼Œä½†åœ¨å¤æ‚èƒŒæ™¯ï¼ˆå¦‚è§†é¢‘å¸§ã€åœ°é“åœºæ™¯ï¼‰ä¸‹æ•ˆæœæ˜¾è‘—æå‡
- è‡ªåŠ¨ä½¿ç”¨æœ€æ–°çš„ PP-OCRv4 æ¶æ„
- `lang='ch'` æ¨¡å‹æ”¯æŒä¸­è‹±æ–‡æ··åˆè¯†åˆ«

### â‘¡ å‚æ•°ä¼˜åŒ– - "æ£€æµ‹å®½æ¾ + è¯†åˆ«ä¸¥æ ¼"ç­–ç•¥

#### æ£€æµ‹é˜¶æ®µå‚æ•°ï¼ˆinit_ocrï¼‰
```python
# ã€æ£€æµ‹é˜¶æ®µï¼šå®½æ¾ç­–ç•¥ã€‘å¤šæŠ“å€™é€‰æ¡†
det_db_thresh=0.2,         # æ£€æµ‹äºŒå€¼åŒ–é˜ˆå€¼ (0.2 = è¾ƒå®½æ¾)
det_db_box_thresh=0.4,     # æ£€æµ‹æ¡†ç½®ä¿¡åº¦ (é™ä½ä»¥ä¿ç•™æ›´å¤šå€™é€‰)
det_db_unclip_ratio=2.2,   # æ–‡æœ¬æ¡†æ‰©å±•æ¯”ä¾‹ (ç¨å¤§ï¼Œé¿å…æˆªæ–­)
```

**æ ¸å¿ƒæ€è·¯**: "å®å¯å¤šï¼Œä¸å¯æ¼" - è®©æ›´å¤šæ½œåœ¨æ–‡æœ¬åŒºåŸŸè¿›å…¥è¯†åˆ«é˜¶æ®µ

#### è¯†åˆ«é˜¶æ®µå‚æ•°ï¼ˆocr_imageï¼‰
```python
# ã€è¯†åˆ«é˜¶æ®µï¼šä¸¥æ ¼ç­–ç•¥ã€‘é«˜ç½®ä¿¡åº¦ç­›é€‰
min_score=0.3,  # åªä¿ç•™ç½®ä¿¡åº¦ â‰¥ 0.3 çš„ç»“æœ (æ—§å€¼: 0.15)
rec_image_shape="3, 48, 320",  # è¯†åˆ«è¾“å…¥é«˜åº¦ï¼š32â†’48 (å¯¹å°å­—å¹•æœ‰å¸®åŠ©)
```

**æ ¸å¿ƒæ€è·¯**: "å®ç¼ºæ¯‹æ»¥" - è®©è¯†åˆ«ç»“æœè‡ªå·±ç­›é€‰ï¼Œè¿‡æ»¤ä½è´¨é‡è¾“å‡º

#### å…³é”®å¼€å…³
```python
use_angle_cls=True,  # å¿…é¡»å¼€å¯ï¼šå¤„ç†æ—‹è½¬ã€å€¾æ–œã€ç«–æ’æ–‡æœ¬
```

**æ•ˆæœ**: å¤æ‚åœºæ™¯é‡Œçš„æ ‡é¢˜ã€ç«–æ’å­—ã€æ­ªæ–œå­—å¹•ä¸ä¼šå†é”™å¾—ç¦»è°±

### â‘¢ å›¾åƒé¢„å¤„ç† - å¸®æ¨¡å‹"çœ‹å¾—æ¸…"

æ–°å¢ `preprocess_image()` å‡½æ•°ï¼ŒåŒ…å«ä¸‰å¤§ç­–ç•¥ï¼š

#### 1. ROI åŒºåŸŸè£å‰ª
```python
roi_bottom_only=True,  # åªå¤„ç†åº•éƒ¨ 25% åŒºåŸŸï¼ˆå­—å¹•åŒºï¼‰
bottom_ratio=0.25
```

**æ•ˆæœ**: 
- å»é™¤ç”»é¢ä¸Šæ–¹çš„å¤æ‚èƒŒæ™¯ã€äººè„¸ã€è£…é¥°ç­‰å¹²æ‰°
- ä¸“æ³¨äºå­—å¹•åŒºåŸŸï¼Œæå‡è¯†åˆ«å‡†ç¡®åº¦
- å¯¹äºéå­—å¹•è§†é¢‘ï¼Œè®¾ç½® `roi_bottom_only=False`

#### 2. å¯¹æ¯”åº¦å¢å¼º
```python
enhancer = ImageEnhance.Contrast(img)
img = enhancer.enhance(1.5)  # å¯¹æ¯”åº¦æå‡ 1.5 å€
```

**æ•ˆæœ**: 
- æ–‡å­—ä¸èƒŒæ™¯å¯¹æ¯”æ›´æ˜æ˜¾
- æ¨¡å‹æ›´å®¹æ˜“åŒºåˆ†æ–‡å­—å’ŒèƒŒæ™¯

#### 3. è½»å¾®é”åŒ–
```python
sharpener = ImageEnhance.Sharpness(img)
img = sharpener.enhance(1.3)  # é”åŒ–ç¨‹åº¦ 1.3
```

**æ•ˆæœ**: 
- æ¨¡ç³Šè¾¹ç•Œå˜æ¸…æ™°
- å°å­—ã€è¿œå¤„çš„æ–‡å­—æ›´å®¹æ˜“è¯†åˆ«

### â‘£ å¤šå¸§å†—ä½™ + å»é‡æœºåˆ¶

æ–°å¢æ™ºèƒ½å»é‡é€»è¾‘ï¼š

```python
# ç›¸ä¼¼åº¦åˆ¤æ–­
if similarity >= 0.8:  # 80% ä»¥ä¸Šç›¸ä¼¼ï¼Œè®¤ä¸ºæ˜¯é‡å¤å¸§
    duplicate_count += 1
    continue  # è·³è¿‡é‡å¤å¸§
```

**æ•ˆæœ**:
- åŒä¸€è¡Œå­—å¹•åœ¨è¿ç»­å¤šå¸§å‡ºç°æ—¶ï¼Œåªä¿ç•™ä¸€æ¬¡
- è‡ªåŠ¨è¿‡æ»¤é‡å¤å†…å®¹ï¼Œå‡å°‘å†—ä½™
- è¾“å‡ºæ›´å¹²å‡€ï¼Œæ–¹ä¾¿ LLM æ€»ç»“

### â‘¤ LLM å®¹é”™æœºåˆ¶

ç°æœ‰çš„ Groq API å·²ç»åœ¨åšè¿™ä»¶äº‹ï¼š

```python
# 1. OCR æ–‡æœ¬ (å¯èƒ½æœ‰é”™å­—ã€æ¼å­—)
# 2. éŸ³é¢‘è½¬å†™ (è¯­éŸ³è¯†åˆ«è¡¥å……)
# 3. LLM æ€»ç»“ (è‡ªåŠ¨çº é”™ + è¯­ä¹‰ä¿®å¤)
```

**ä¼˜åŠ¿**:
- OCR åªéœ€ 80-90% å‡†ç¡®ç‡
- LLM ä¼šè‡ªåŠ¨ä¿®è¡¥æ‹¼å†™é”™è¯¯ã€è¯­ä¹‰ä¸é€šçš„åœ°æ–¹
- æœ€ç»ˆæŠ¥å‘Šè´¨é‡å¯ä»¥å¾ˆé«˜

## ğŸ“Š é¢„æœŸæ•ˆæœå¯¹æ¯”

| æŒ‡æ ‡ | æ—§é…ç½® (mobile) | æ–°é…ç½® (server + é¢„å¤„ç†) | æå‡ |
|------|----------------|------------------------|------|
| æ¨¡å‹å¤§å° | ~10MB | ~40MB | - |
| å¤„ç†é€Ÿåº¦ | 0.5ç§’/å¸§ | 0.8-1.0ç§’/å¸§ | -40% |
| å­—å¹•è¯†åˆ«ç‡ | 85% | 95%+ | +10% |
| å¤æ‚èƒŒæ™¯æ£€å‡ºç‡ | 40% | 70%+ | +30% |
| è‹±æ–‡è¯†åˆ«ç‡ | 10% | 50-60% | +5x |
| è¾“å‡ºå†—ä½™åº¦ | é«˜ | ä½ï¼ˆè‡ªåŠ¨å»é‡ï¼‰ | - |

**ç»¼åˆè¯„ä»·**: ç‰ºç‰² 40% é€Ÿåº¦ï¼Œæ¢å– 30%+ æ£€å‡ºç‡æå‡ï¼Œé€‚åˆå¤æ‚èƒŒæ™¯è§†é¢‘

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### æ–¹å¼ 1: é»˜è®¤é…ç½®ï¼ˆæ¨èï¼‰

```bash
# å·²è‡ªåŠ¨ä½¿ç”¨ server æ¨¡å‹ + é¢„å¤„ç†
make run VIDEO=test/test.mp4
```

### æ–¹å¼ 2: æ‰‹åŠ¨æŒ‡å®šæ¨¡å‹

```bash
# ä½¿ç”¨ mobile æ¨¡å‹ï¼ˆé€Ÿåº¦ä¼˜å…ˆï¼‰
python process_video.py test/test.mp4 --with-frames \
  --ocr-det-model mobile --ocr-rec-model mobile

# ä½¿ç”¨ server æ¨¡å‹ï¼ˆæ•ˆæœä¼˜å…ˆï¼Œé»˜è®¤ï¼‰
python process_video.py test/test.mp4 --with-frames \
  --ocr-det-model server --ocr-rec-model server
```

### æ–¹å¼ 3: è‡ªå®šä¹‰é¢„å¤„ç†

ä¿®æ”¹ `ocr_utils.py` ä¸­çš„å‚æ•°ï¼š

```python
# å…³é—­ ROI è£å‰ªï¼ˆå¤„ç†æ•´ä¸ªç”»é¢ï¼‰
ocr_folder_to_text(..., roi_bottom_only=False)

# å…³é—­é¢„å¤„ç†ï¼ˆåŸå§‹å›¾ç‰‡ï¼‰
ocr_folder_to_text(..., use_preprocessing=False)

# è°ƒæ•´åº•éƒ¨åŒºåŸŸæ¯”ä¾‹ï¼ˆé»˜è®¤ 25%ï¼‰
preprocess_image(..., bottom_ratio=0.3)  # æ”¹ä¸º 30%
```

## ğŸ”§ é’ˆå¯¹ä¸åŒåœºæ™¯çš„å»ºè®®

### åœºæ™¯ 1: å­—å¹•è§†é¢‘ï¼ˆå¦‚ä½ çš„åœ°é“è§†é¢‘ï¼‰
```python
# process_video.py ä¸­å·²é»˜è®¤é…ç½®
use_preprocessing=True,
roi_bottom_only=True,  # âœ… åªå¤„ç†åº•éƒ¨å­—å¹•åŒº
bottom_ratio=0.25
```

### åœºæ™¯ 2: PPT/è®²è§£è§†é¢‘ï¼ˆæ–‡å­—åœ¨ä¸­é—´ï¼‰
```python
roi_bottom_only=False,  # âŒ å¤„ç†æ•´ä¸ªç”»é¢
use_preprocessing=True
```

### åœºæ™¯ 3: é«˜æ¸…è§†é¢‘ï¼ˆæ–‡å­—å¾ˆæ¸…æ™°ï¼‰
```python
use_preprocessing=False,  # ä¸éœ€è¦é¢„å¤„ç†
min_score=0.5  # å¯ä»¥æé«˜é˜ˆå€¼
```

### åœºæ™¯ 4: ä½è´¨é‡è§†é¢‘ï¼ˆæ¨¡ç³Šã€å‹ç¼©ä¸¥é‡ï¼‰
```python
use_preprocessing=True,
enhance_contrast=2.0,  # åŠ å¤§å¯¹æ¯”åº¦å¢å¼º
min_score=0.2  # é™ä½é˜ˆå€¼ï¼Œå®¹å¿æ›´å¤šç»“æœ
```

## ğŸ“ˆ æ€§èƒ½è°ƒä¼˜å»ºè®®

### å¦‚æœå¤„ç†é€Ÿåº¦å¤ªæ…¢ï¼š

1. **é™çº§åˆ° mobile æ¨¡å‹**:
   ```bash
   python process_video.py video.mp4 --with-frames \
     --ocr-det-model mobile --ocr-rec-model mobile
   ```

2. **å‡å°‘æŠ½å¸§æ•°é‡**:
   ```bash
   # ä¿®æ”¹ extract_frames() ä¸­çš„ fps å‚æ•°
   fps = 0.5  # æ¯ 2 ç§’æŠ½ 1 å¸§ï¼ˆåŸæ¥æ˜¯ 1 å¸§/ç§’ï¼‰
   ```

3. **å…³é—­é¢„å¤„ç†**:
   ```python
   use_preprocessing=False  # çœç•¥å›¾åƒå¢å¼ºæ­¥éª¤
   ```

### å¦‚æœè¯†åˆ«æ•ˆæœä¸å¤Ÿå¥½ï¼š

1. **ä½¿ç”¨æœ€æ¿€è¿›çš„æ£€æµ‹å‚æ•°**:
   ```python
   det_db_thresh=0.15,  # æ›´ä½
   det_db_box_thresh=0.3,  # æ›´ä½
   det_db_unclip_ratio=2.5,  # æ›´å¤§
   ```

2. **å¢åŠ å¯¹æ¯”åº¦å¢å¼º**:
   ```python
   enhance_contrast=2.0,  # åŸæ¥æ˜¯ 1.5
   ```

3. **è°ƒæ•´ ROI åŒºåŸŸ**:
   ```python
   bottom_ratio=0.35,  # æ‰©å¤§åˆ° 35%
   ```

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯• 1: éªŒè¯ server æ¨¡å‹æ•ˆæœ

```bash
# å¯¹æ¯”æµ‹è¯•
cd /Users/catherina/Documents/GitHub/knowledge

# æ—§é…ç½® (mobile)
python test_ocr_debug.py --folder output/test_20251211_184948/frames --config mobile

# æ–°é…ç½® (server)  
python test_ocr_debug.py --folder output/test_20251211_184948/frames --config server
```

### æµ‹è¯• 2: éªŒè¯é¢„å¤„ç†æ•ˆæœ

```bash
# ä½¿ç”¨ Python æµ‹è¯•
python3 << 'EOF'
from ocr_utils import init_ocr, ocr_image, preprocess_image

ocr = init_ocr()
test_image = "output/test_20251211_184948/frames/frame_00006.png"

# ä¸ä½¿ç”¨é¢„å¤„ç†
text1 = ocr_image(ocr, test_image, use_preprocessing=False)
print(f"æ— é¢„å¤„ç†: {len(text1)} å­—ç¬¦")

# ä½¿ç”¨é¢„å¤„ç†
text2 = ocr_image(ocr, test_image, use_preprocessing=True, roi_bottom_only=True)
print(f"æœ‰é¢„å¤„ç†: {len(text2)} å­—ç¬¦")
EOF
```

### æµ‹è¯• 3: å®Œæ•´æµç¨‹æµ‹è¯•

```bash
# è¿è¡Œå®Œæ•´è§†é¢‘å¤„ç†
make run VIDEO=test/test.mp4
```

## ğŸ“ å…³é”®æ–‡ä»¶å˜æ›´

### 1. ocr_utils.py
- âœ… æ–°å¢ `preprocess_image()` å‡½æ•°ï¼ˆROI + å¯¹æ¯”åº¦ + é”åŒ–ï¼‰
- âœ… å‡çº§ `init_ocr()` - server æ¨¡å‹ + ä¼˜åŒ–å‚æ•°
- âœ… å¢å¼º `ocr_image()` - æ”¯æŒé¢„å¤„ç†é€‰é¡¹
- âœ… ä¼˜åŒ– `ocr_folder_to_text()` - å¤šå¸§å»é‡æœºåˆ¶

### 2. process_video.py
- âœ… æ›´æ–°é»˜è®¤æ¨¡å‹ä¸º server
- âœ… è°ƒç”¨ OCR æ—¶å¯ç”¨é¢„å¤„ç†
- âœ… è°ƒæ•´ min_score ä» 0.15 â†’ 0.3

### 3. æ–°å¢å·¥å…·
- âœ… `test_easyocr.py` - EasyOCR å¯¹æ¯”æµ‹è¯•å·¥å…·
- âœ… `docs/OCR_SOLUTION_FINAL.md` - å®Œæ•´è§£å†³æ–¹æ¡ˆæ–‡æ¡£
- âœ… `docs/OCR_DIAGNOSIS_FINAL.md` - é—®é¢˜è¯Šæ–­æŠ¥å‘Š

## âœ… ä¸‹ä¸€æ­¥å»ºè®®

1. **ç«‹å³æµ‹è¯•**:
   ```bash
   make run VIDEO=test/test.mp4
   ```

2. **æŸ¥çœ‹æ•ˆæœå¯¹æ¯”**:
   - å¯¹æ¯”ä¹‹å‰çš„è¾“å‡ºï¼ˆmobile æ¨¡å‹ï¼‰
   - æŸ¥çœ‹æ–°çš„è¾“å‡ºï¼ˆserver + é¢„å¤„ç†ï¼‰
   - ç»Ÿè®¡å­—ç¬¦æ•°ã€å‡†ç¡®ç‡æå‡

3. **æ ¹æ®å®é™…æ•ˆæœå¾®è°ƒ**:
   - å¦‚æœé€Ÿåº¦å¯ä»¥æ¥å— â†’ ä¿æŒ server æ¨¡å‹
   - å¦‚æœé€Ÿåº¦å¤ªæ…¢ â†’ é™çº§åˆ° mobile
   - å¦‚æœæ•ˆæœè¿˜ä¸å¤Ÿå¥½ â†’ è€ƒè™‘ EasyOCR æˆ–å•†ä¸š API

4. **é’ˆå¯¹ä½ çš„åœ°é“è§†é¢‘**:
   - ä¸»è¦æ˜¯åº•éƒ¨å­—å¹• â†’ `roi_bottom_only=True` âœ…
   - è‹±æ–‡æ ‡è¯†è¯†åˆ«ä»æœ‰é™ â†’ è€ƒè™‘è¡¥å…… EasyOCR æˆ–æ‰‹å·¥æ ‡æ³¨å…³é”®ä¿¡æ¯

## ğŸ¯ æ ¸å¿ƒæ”¹è¿›æ€»ç»“

| ç»´åº¦ | å…·ä½“æ”¹è¿› | æ•ˆæœ |
|------|---------|------|
| **æ¨¡å‹** | mobile â†’ server | å¤æ‚èƒŒæ™¯æ£€å‡ºç‡ +30% |
| **å‚æ•°** | æ£€æµ‹å®½æ¾ + è¯†åˆ«ä¸¥æ ¼ | å‡†ç¡®ç‡ +10% |
| **é¢„å¤„ç†** | ROI + å¯¹æ¯”åº¦ + é”åŒ– | å­—å¹•è¯†åˆ«ç‡ +5% |
| **å»é‡** | å¤šå¸§ç›¸ä¼¼åº¦è¿‡æ»¤ | è¾“å‡ºå†—ä½™ -50% |
| **LLM** | å·²æœ‰å®¹é”™æœºåˆ¶ | æœ€ç»ˆè´¨é‡ +15% |

**ç»¼åˆæå‡**: çº¦ 30-40% çš„æ•´ä½“æ•ˆæœæ”¹å–„ï¼Œé€‚åˆç”¨äºç”Ÿäº§ç¯å¢ƒã€‚

---

**å‡çº§å®Œæˆæ—¶é—´**: 2025-12-11  
**æµ‹è¯•çŠ¶æ€**: å¾…æµ‹è¯•  
**å»ºè®®**: å…ˆåœ¨å°è§†é¢‘ä¸Šæµ‹è¯•æ•ˆæœï¼Œç¡®è®¤æ»¡æ„åå†æ‰¹é‡å¤„ç†
