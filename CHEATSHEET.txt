╔═══════════════════════════════════════════════════════════════╗
║          📹 Video Report Pipeline - 快速参考卡片               ║
║         🆕 统一视频下载层 + 自动环境 + OCR 模型选择            ║
╚═══════════════════════════════════════════════════════════════╝

📍 项目位置
───────────────────────────────────────────────────────────────
/Users/catherina/Documents/GitHub/knowledge/

✨ 新特性（2025-12-11）
───────────────────────────────────────────────────────────────
• 🎯 首次运行自动创建虚拟环境和安装依赖
• 🤖 支持选择不同性能级别的 OCR 模型
• 🔧 修复 PaddleOCR 新版本兼容性问题
• 📦 所有依赖自动隔离在项目的 .venv 目录
• 🆕 统一视频下载层 - 支持 YouTube、Bilibili、小红书等
• 🆕 智能降级策略 - yt-dlp → BBDown → XHS-Downloader
• 🆕 从URL直接处理视频 - 下载+抽帧+OCR+ASR+总结一键完成

🚀 核心命令（最常用）
───────────────────────────────────────────────────────────────
┌─ 本地视频：音频模式（快速）──────────────────────────────────┐
│ make run VIDEO=视频路径                                      │
│ 流程：音频提取 → Groq转写 → AI总结                           │
│ 适合：播客、会议、讲座                                       │
│ 速度：⚡⚡⚡ 快                                              │
└────────────────────────────────────────────────────────────┘

┌─ 本地视频：OCR模式（完整）───────────────────────────────────┐
│ make ocr VIDEO=视频路径                                      │
│ 流程：1️⃣ OCR识别 → 2️⃣ 音频转写 → 3️⃣ AI总结                │
│ 特点：先处理OCR确认无误，再处理音频                          │
│ 适合：教学视频、演示PPT、代码演示                            │
│ 速度：🐢 慢（带进度条实时显示）                              │
└────────────────────────────────────────────────────────────┘

┌─ 🆕 从URL下载并处理：仅音频 ─────────────────────────────────┐
│ make download-run URL="https://www.youtube.com/watch?v=xxx" │
│ make download-run URL="朋友分享的视频：链接在这..."           │
│ 流程：下载 → 音频提取 → Groq转写 → AI总结                    │
│ 支持：YouTube, Bilibili, 小红书, 抖音, Twitter等            │
│ 特点：✨自动从文本中提取URL，自动下载到 videos/             │
│ 速度：⚡⚡ 中等（含下载时间）                                │
└────────────────────────────────────────────────────────────┘

┌─ 🆕 从URL下载并处理：完整OCR ────────────────────────────────┐
│ make download-ocr URL="https://www.bilibili.com/video/BVxxx"│
│ make download-ocr URL="看这个视频很有趣：链接..."            │
│ 流程：下载 → 抽帧 → OCR → 音频 → AI总结                      │
│ 特点：✨自动从分享文本中提取URL，所有平台统一处理             │
│ 速度：🐢 慢（含下载+OCR）                                    │
└────────────────────────────────────────────────────────────┘

┌─ 本地视频：OCR模式 + 模型选择 ──────────────────────────────┐
│ # 高精度模式（推荐重要内容）                                  │
│ make ocr VIDEO=xxx DET_MODEL=server REC_MODEL=server        │
│                                                              │
│ # 快速模式（推荐日常使用，默认）                              │
│ make ocr VIDEO=xxx DET_MODEL=mobile REC_MODEL=mobile        │
│                                                              │
│ # 平衡模式（性价比最高）                                      │
│ make ocr VIDEO=xxx DET_MODEL=mobile REC_MODEL=server        │
│                                                              │
│ 💡 OCR 已优化参数，可识别：                                  │
│    ✓ 中文字幕  ✓ 英文文本  ✓ 数字  ✓ 混合文本               │
│    • 检测阈值: 0.2 (更敏感)                                  │
│    • 置信度过滤: 0.25 (保留更多结果)                         │
│    • 文本框扩展: 1.8x (捕获边缘文本)                         │
└────────────────────────────────────────────────────────────┘

📝 示例
───────────────────────────────────────────────────────────────
本地文件处理：
  make run VIDEO=~/Downloads/meeting.mp4
  make ocr VIDEO=~/Desktop/tutorial.mp4

URL下载处理 - 直接链接：
  make download-run URL="https://www.youtube.com/watch?v=dQw4w9WgXcQ"
  make download-ocr URL="https://www.bilibili.com/video/BV1xx411c7mD"

✨ URL下载处理 - 自动提取（分享文本）：
  make download-run URL="朋友推荐的视频：https://youtu.be/xxx 非常有趣"
  make download-ocr URL="B站分享 - https://b23.tv/abc123 - 必看"

仅下载（不处理）：
  make download URL="https://www.youtube.com/watch?v=xxxxx"

💡 URL提取功能 - 智能识别
───────────────────────────────────────────────────────────────
✨ 无需手动提取，直接粘贴分享内容：
  • 支持完整URL：https://www.bilibili.com/video/BVxxx
  • 支持短链接：https://b23.tv/abc123
  • 支持分享文本：分享一个视频给你：链接在这 https://...
  • 自动清理尾部标点：链接）、链接。等都能识别

系统自动识别 → 提取 → 下载处理，无需手动操作！

🔧 环境配置
───────────────────────────────────────────────────────────────
🆕 自动模式（推荐）：
  直接运行 make run 或 make ocr，首次会自动：
  • 创建虚拟环境 (.venv)
  • 安装所有依赖（包括 yt-dlp 用于下载）
  • 运行环境自检
  • 创建配置文件模板

手动模式（可选）：
  make setup          # 手动初始化环境
  nano .env           # 填入 GROQ_API_KEY
  make check          # 验证配置

🌐 支持的视频平台
───────────────────────────────────────────────────────────────
✅ 完全支持：
  • YouTube (youtube.com, youtu.be)
  • Bilibili (bilibili.com, b23.tv)

⚠️ 需配置：
  • 小红书 (xiaohongshu.com) - 需安装 XHS-Downloader
  • 抖音 (douyin.com) - 需测试
  • Twitter/X (twitter.com, x.com) - 需测试

🎨 下载文件命名规范
───────────────────────────────────────────────────────────────
格式：标题_平台_视频ID.mp4

示例：
  Never_Gonna_Give_You_Up_youtube_dQw4w9WgXcQ.mp4
  某个有趣的视频标题_bilibili_BV1xx411c7mD.mp4
  INTP：你不是迷茫而是在逃避真正的目标_bilibili_BV1ngCyBiEkc.mp4

特点：
  • 文件名以标题开头，易于识别内容
  • 包含平台标记，便于溯源
  • 包含视频ID，便于快速查找
  • 存储在 videos/ 目录

存储位置：videos/ 目录

🛠️ 维护命令
───────────────────────────────────────────────────────────────
make help           # 查看所有命令（含下载命令）
make test           # 运行环境测试
make check          # 检查配置状态
make clean          # 清理输出文件
make show-report    # 查看最新报告
make list-reports   # 列出所有报告

🔍 OCR 调试工具
───────────────────────────────────────────────────────────────
python test_ocr_debug.py --check-api              # 检查OCR状态
python test_ocr_debug.py --image xxx.png          # 测试单张图片
python test_ocr_debug.py --folder frames/         # 批量测试
python test_ocr_debug.py --compare-thresholds     # 对比阈值
python test_ocr_debug.py --help                   # 查看帮助

📚 详细文档: docs/OCR_DEBUG_GUIDE.md

📂 输出位置
───────────────────────────────────────────────────────────────
output/
└── 视频名_时间戳/          # 每次处理独立文件夹
    ├── 视频名.wav          # 提取的音频
    ├── frames/            # 抽取的视频帧（OCR模式）
    ├── transcript_raw.txt # 语音识别原文
    ├── ocr_raw.txt        # OCR识别原文（如启用）
    └── report.txt         # 格式化的AI报告

示例: output/test_20251211_183934/

🔑 配置文件
───────────────────────────────────────────────────────────────
.env                # API密钥和参数配置

必填：
  GROQ_API_KEY=gsk_xxxxx

可选：
  GROQ_ASR_MODEL=whisper-large-v3-turbo
  GROQ_LLM_MODEL=openai/gpt-oss-120b
  GROQ_MAX_TOKENS=4096
  GROQ_TEMPERATURE=0.7

⚡ 性能对比
───────────────────────────────────────────────────────────────
处理模式对比：
┌──────────┬─────────────┬─────────────┬──────────────┐
│ 模式     │ 处理时间    │ 输出内容    │ 适用场景     │
├──────────┼─────────────┼─────────────┼──────────────┤
│ make run │ ⚡ 快        │ 音频文字    │ 音频为主     │
│ make ocr │ 🐢 慢        │ 音频+画面   │ 画面有文字   │
│下载模式  │ ⚡⚡ 中等    │ 同上+下载   │ 在线视频     │
└──────────┴─────────────┴─────────────┴──────────────┘

OCR模型对比（基于52帧视频测试）：
┌────────────────────┬──────────┬──────────┬──────────┐
│ 模型配置           │ 总耗时   │ 单帧耗时 │ 精确度   │
├────────────────────┼──────────┼──────────┼──────────┤
│ mobile + mobile    │ ~90秒    │ ~1.7秒   │ 85-90%   │
│ mobile + server    │ ~120秒   │ ~2.3秒   │ 90-95%   │
│ server + server    │ ~180秒   │ ~3.5秒   │ 95-98%   │
└────────────────────┴──────────┴──────────┴──────────┘

💡 推荐：mobile模型适合大多数场景，清晰文字识别率已足够

🆘 快速故障排查
───────────────────────────────────────────────────────────────
问题：GROQ_API_KEY 未设置
解决：nano .env （填入真实密钥）

问题：ffmpeg 未安装
解决：brew install ffmpeg

问题：下载失败（yt-dlp 错误）
解决：pip install --upgrade yt-dlp

问题：OCR 处理很慢
解决：使用 mobile 模型（默认）或减少抽帧频率

问题：OCR 识别不准确
解决：使用 server 模型提高精度
      make ocr VIDEO=xxx DET_MODEL=server REC_MODEL=server

问题：虚拟环境损坏
解决：make clean-all && make test （清理并重建）

问题：内存不足
解决：使用 mobile 模型，或减少同时处理的帧数

问题：首次运行很慢
说明：正在自动下载模型和依赖，后续会很快

问题：B站下载失败
解决：安装 BBDown: brew install bbdown

📚 文档
───────────────────────────────────────────────────────────────
docs/
├── AUTO_VENV.md              # 自动虚拟环境功能说明
├── OCR_MODELS.md             # OCR 模型选择详细指南
├── DOWNLOAD_GUIDE.md         # 🆕 完整下载功能指南
├── DOWNLOAD_README.md        # 🆕 下载快速参考
├── DOWNLOAD_IMPLEMENTATION.md # 🆕 下载功能实现细节
├── GROQ_SETUP.md             # Groq API 配置指南
├── QUICKSTART.md             # 快速入门
└── START.md                  # 详细启动指南

README.md                      # 完整项目文档

💡 Pro Tips
───────────────────────────────────────────────────────────────
1. 🆕 首次使用直接开始，无需手动配置：
   make run VIDEO=video.mp4  # 自动完成所有环境配置

2. 🆕 从URL一键下载并处理：
   make download-run URL="https://www.youtube.com/watch?v=xxx"
   make download-ocr URL="https://www.bilibili.com/video/BVxxx"

3. 🆕 支持多个平台的视频，统一处理流程：
   make download-ocr URL="https://example.com/video"
   # 支持 YouTube, Bilibili, 小红书, 抖音, Twitter 等

4. OCR模式带进度条，实时查看处理进度：
   make ocr VIDEO=xxx.mp4  # 显示"🔍 OCR进度: 52/52"

5. 批量处理多个视频：
   for f in *.mp4; do make run VIDEO="$f"; done

6. 使用绝对路径避免问题：
   make run VIDEO="$(pwd)/video.mp4"

7. 查看实时处理日志：
   make run VIDEO=xxx.mp4 2>&1 | tee process.log

8. 自定义输出目录：
   python process_video.py video.mp4 --out-dir /custom/path

9. 根据设备性能选择 OCR 模型：
   # 普通笔记本 → mobile（默认）
   # 高性能工作站 → server
   # 平衡模式 → mobile检测 + server识别

10. OCR流程优化 - 先OCR后音频：
    # 如果OCR识别有问题，可以及早发现
    # 不会浪费时间在音频转写上

11. 清理并重置环境：
    make clean-all  # 删除虚拟环境和输出文件
    make test       # 重新创建环境并测试

12. 查看环境状态：
    make check      # 显示虚拟环境、配置、依赖等状态

🌐 相关链接
───────────────────────────────────────────────────────────────
Groq Console: https://console.groq.com
Groq API Docs: https://console.groq.com/docs
获取API Key: https://console.groq.com/keys

🎓 快速上手步骤
───────────────────────────────────────────────────────────────
1️⃣  确保安装 ffmpeg: brew install ffmpeg
2️⃣  直接运行（首次自动配置）: make run VIDEO=test.mp4
3️⃣  编辑 .env 填入 GROQ_API_KEY（如需AI总结）
4️⃣  开始使用：
    • 本地视频：make run 或 make ocr
    • 网络视频：make download-run 或 make download-ocr

就这么简单！🎉

═══════════════════════════════════════════════════════════════

╔═══════════════════════════════════════════════════════════════╗
║          🗄️  数据库与搜索系统 - 快速参考                      ║
║         （视频内容持久化 + 智能检索）                          ║
╚═══════════════════════════════════════════════════════════════╝

🎯 核心功能
───────────────────────────────────────────────────────────────
✅ 自动保存所有处理结果到数据库
✅ 全文搜索（支持中英文混合）
✅ 按标签快速筛选
✅ 时间戳精确定位（可跳转到视频）
✅ 视频去重（自动跳过已处理）
✅ 智能标签管理

🚀 快速部署（3步）
───────────────────────────────────────────────────────────────
1️⃣  初始化数据库：
    make db-init

2️⃣  测试功能：
    make db-test

3️⃣  开始使用：
    # 处理视频会自动入库
    make run VIDEO=video.mp4
    
    # 搜索内容
    make search Q="关键词"

🔍 搜索命令
───────────────────────────────────────────────────────────────
┌─ 全文搜索 ────────────────────────────────────────────────┐
│ make search Q="关键词"                                      │
│ make search Q="机器学习"                                    │
│ make search Q="深度学习" FLAGS="--field transcript"        │
│ make search Q="神经网络" FLAGS="--sort date"               │
│                                                            │
│ 搜索范围：报告、转写、OCR、主题（全部内容）                │
│ 返回结果：匹配片段 + 时间戳 + 标签 + 相关性分数            │
└──────────────────────────────────────────────────────────┘

┌─ 按标签搜索 ──────────────────────────────────────────────┐
│ make search-tags TAGS="标签1 标签2"                        │
│ make search-tags TAGS="教育 科技"                          │
│ make search-tags TAGS="机器学习 深度学习"                  │
│                                                            │
│ 逻辑：AND（必须包含所有标签）                               │
│ 返回：符合条件的所有视频                                   │
└──────────────────────────────────────────────────────────┘

┌─ 搜索主题 ────────────────────────────────────────────────┐
│ make search-topics Q="主题关键词"                           │
│ make search-topics Q="卷积神经网络"                         │
│                                                            │
│ 搜索范围：主题标题 + 主题摘要                               │
│ 返回：匹配的章节 + 时间范围                                 │
└──────────────────────────────────────────────────────────┘

🏷️  标签管理
───────────────────────────────────────────────────────────────
查看热门标签：
  make db-tags

标签自动补全（命令行工具）：
  python search_cli.py suggest "机器"

💡 标签自动提取
  • 处理视频时 LLM 自动提取标签
  • 可手动添加/修改标签（Python API）

🗄️  数据库管理
───────────────────────────────────────────────────────────────
初始化数据库：
  make db-init

查看数据库状态：
  make db-status

测试所有功能：
  make db-test

重建数据库（删除所有数据）：
  make db-reset

备份数据库：
  make db-backup

优化数据库（定期维护）：
  make db-vacuum

📊 搜索返回结果示例
───────────────────────────────────────────────────────────────
╭─────────────────────────────────────────────────────────────╮
│ 🔍 找到 3 个结果:                                            │
│                                                             │
│ [1] 机器学习基础教程                                         │
│     来源: transcript                                         │
│     片段: ...介绍神经网络的基本概念和结构...                  │
│     时间: 02:15                                             │
│     相关性: 0.85                                            │
│     标签: 教育, 机器学习, AI                                 │
│                                                             │
│ [2] 深度学习实战                                             │
│     来源: report                                            │
│     片段: ...卷积神经网络（CNN）的应用...                     │
│     时间: 05:32                                             │
│     相关性: 0.78                                            │
│     标签: 深度学习, CNN, 计算机视觉                          │
╰─────────────────────────────────────────────────────────────╯

🎯 高级用法（Python API）
───────────────────────────────────────────────────────────────
from db import SearchRepository

repo = SearchRepository()

# 全文搜索
results = repo.search(
    query="机器学习",
    tags=["教育", "科技"],
    fields='transcript',      # report/transcript/ocr/all
    sort_by='relevance',      # relevance/date/duration
    limit=20
)

# 处理结果
for result in results:
    print(f"视频: {result.video_title}")
    print(f"时间: {result.timestamp_seconds}s")
    print(f"片段: {result.matched_snippet}")
    print(f"文件: {result.file_path}")

📂 数据库文件位置
───────────────────────────────────────────────────────────────
storage/
├── database/
│   └── knowledge.db          # 主数据库（SQLite）
├── backups/                  # 备份目录
│   └── knowledge_backup_*.db
├── videos/                   # 原视频文件
└── artifacts/                # 处理产物
    └── {video_hash}/
        ├── frames/           # 抽帧图片
        ├── transcript.json
        ├── ocr.json
        └── report.md

📊 数据库表结构
───────────────────────────────────────────────────────────────
videos           → 视频元信息（来源、时长、状态）
artifacts        → 转写/OCR/报告产物
tags             → 标签体系
video_tags       → 视频-标签关联
topics           → 主题/章节
timeline_entries → 时间线（秒级精度）
fts_content      → 全文搜索索引（FTS5）
embeddings       → 向量表（预留，未来扩展）
processing_logs  → 处理日志

💡 Pro Tips - 数据库篇
───────────────────────────────────────────────────────────────
1. 自动入库：
   # 处理视频时自动保存到数据库，无需额外操作
   make run VIDEO=video.mp4

2. 搜索带时间戳：
   # 搜索结果包含精确时间点，可直接跳转播放
   make search Q="关键词"

3. 视频自动去重：
   # 基于文件内容 hash，重复视频自动跳过
   make run VIDEO=same_video.mp4  # 第二次会提示已存在

4. 批量搜索：
   # 使用命令行工具进行复杂查询
   python search_cli.py search "关键词" --field transcript --json

5. 定期备份：
   # 建议每周备份一次
   make db-backup

6. 性能优化：
   # 每处理1000个视频后执行一次
   make db-vacuum

7. 查看统计信息：
   make db-status
   # 显示：视频数、产物数、标签数、数据库大小

8. 标签过滤组合：
   # 查找同时包含多个标签的视频
   make search-tags TAGS="机器学习 深度学习 Python"

9. 搜索特定字段：
   make search Q="代码" FLAGS="--field ocr"  # 仅搜索OCR
   make search Q="演讲" FLAGS="--field transcript"  # 仅搜索转写

10. 导出搜索结果：
    python search_cli.py search "关键词" --json > results.json

11. 时间范围搜索（Python API）：
    # 在代码中可以按处理时间过滤
    from db import VideoRepository
    videos = repo.list_videos(limit=100)

12. SQLite 直接查询（高级）：
    sqlite3 storage/database/knowledge.db
    SELECT title, duration_seconds FROM videos;

🔧 故障排查 - 数据库
───────────────────────────────────────────────────────────────
问题：数据库文件不存在
解决：make db-init

问题：搜索无结果
解决：
  1. 确认已处理视频并入库
  2. 检查搜索关键词是否正确
  3. 尝试简化搜索词

问题：数据库锁定
解决：
  sqlite3 storage/database/knowledge.db "PRAGMA wal_checkpoint;"

问题：搜索很慢
解决：
  1. make db-vacuum  # 优化数据库
  2. 减少返回结果数量（--limit 参数）

问题：想清空数据库重新开始
解决：make db-reset

📚 数据库文档
───────────────────────────────────────────────────────────────
docs/
├── DATABASE_DESIGN.md        # 完整设计文档
├── DATABASE_QUICKSTART.md    # 快速开始指南
├── DATABASE_SUMMARY.md       # 实施总结
└── DATABASE_README.md        # 功能概览

🎓 数据库快速上手
───────────────────────────────────────────────────────────────
1️⃣  首次使用：
    make db-init         # 初始化数据库
    make db-test         # 测试功能

2️⃣  处理视频：
    make run VIDEO=test.mp4    # 自动入库

3️⃣  搜索内容：
    make search Q="测试"       # 全文搜索
    make db-tags               # 查看标签
    make db-status             # 查看统计

4️⃣  定期维护：
    make db-backup      # 每周备份
    make db-vacuum      # 每月优化

就这么简单！🎉

🌟 数据库功能亮点
───────────────────────────────────────────────────────────────
✨ 零配置：SQLite 单文件，无需安装额外服务
✨ 全文搜索：FTS5 引擎，支持中英文混合
✨ 智能去重：SHA256 hash 自动识别重复视频
✨ 时间定位：搜索结果精确到秒，可跳转播放
✨ 标签系统：自动提取 + 手动管理
✨ 扩展性强：预留向量表，支持未来语义搜索

═══════════════════════════════════════════════════════════════
📌 最后更新：2025-12-12
✨ 版本：v3.0 - 数据库与搜索系统 + 统一下载 + 智能 OCR
打印或保存这张卡片，随时查阅！🎯
